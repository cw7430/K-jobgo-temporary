<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}" />	
	<meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}" />

 	<title>(주)한국경영지원사업단 | 외국인 인재 매칭 플랫폼 - K‑jobgo 구직신청서 상세보기</title>
    
<link rel="icon" href="https://k-jobgo-profile-photos-seoul.s3.ap-northeast-2.amazonaws.com/img/favicon.png" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" th:href="@{/css/layout.css}" />
    <link rel="stylesheet" th:href="@{/css/toggle.css}" />
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" th:href="@{/css/login.css}" />
    <link rel="stylesheet" th:href="@{/css/applyEmp.css}" />
</head>

   <!-- 
<body class="all-page"
      th:attr="data-is-admin=${isAdmin} ?: false, 
               data-authority=${authorityId} ?: 0, 
               data-env=${@environment.getActiveProfiles()[0]}">
                -->
<body class="all-page"
      th:attr="data-is-admin=${isAdmin != null ? isAdmin : false},
               data-authority=${authorityId != null ? authorityId : 0},
               data-env=${#arrays.length(@environment.getActiveProfiles()) > 0 ? @environment.getActiveProfiles()[0] : ''}">

 <!-- 관리자 전용, 고객 전용 토글 메뉴 -->
 <div th:replace="${isClient} ? ~{fragments/clientHeader :: siteHeader} : ~{fragments/header :: siteHeader}"></div>

  <!-- ✅ K-jobgo 로고 전용 중앙 박스 (about-section 위에 배치) -->
<div class="center-kjobgo-logo">
<a th:href="@{/}">
  <img src="/img/k-jobgo_company.png" alt="K-jobgo | 외국인 인재 매칭 플랫폼" class="k-jobgologo" />
</a>
</div>

 <main class="container">
<!-- 상태/담당자 카드 -->
<!-- ===== 관리자 워크벤치: 좌측 상태(스티키) + 우측 상담 폼 ===== -->
<section class="layout-two" th:if="${isAdmin}">
  <!-- 좌측: 상태 카드 (스티키) -->
  <aside class="card sticky">
    <h3>신청 상태</h3>
    <div class="row">
      <label>현재 상태</label>
      <div>
        <!-- 클래스는 ENUM 이름으로, 텍스트는 한글 라벨로 -->
		<span class="badge"
		      th:classappend="${(job.status != null) ? ' status-' + job.status.name() : ''}"
		      th:text="${(job.status != null) ? statusLabel[job.status.name()] : '-'}">
		  -
		</span>
      </div>
    </div>

    <div class="row" th:if="${job.handledBy}">
      <label>담당자</label>
      <div th:text="${job.handledBy}">-</div>
    </div>

    <div class="row" th:if="${job.handledAt}">
      <label>처리일</label>
      <div th:text="${#temporals.format(job.handledAt,'yyyy-MM-dd HH:mm')}">-</div>
    </div>
   </aside>
   
    <!-- 우측: 상담 기록 폼 (상태 변경 포함 단일 저장) -->
      <section class="card">
        <h3>상담 기록 작성</h3>

        <!-- 한 번에 저장: 상담 + (선택)상태변경 -->
        <form th:action="${logPostUrl}" method="post" th:object="${adminLogForm}" id="logForm">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

          <div class="grid two">
            <div class="row">
              <label>처리 상담자</label>
              <input type="text" th:field="*{handledBy}" placeholder="상담자명" required>
            </div>
            <div class="row">
              <label>참고사항</label>
              <textarea rows="3" th:field="*{referenceNote}" placeholder="특이사항, 주의사항 등 내용을 입력하세요" required></textarea>
            </div>
          </div>

          <div class="row">
            <label>상담내용</label>
            <textarea rows="5" th:field="*{counselContent}" placeholder="상담 내용을 입력하세요" required></textarea>
          </div>
         
         <!-- 상태 변경(선택) -->
          <div class="row">
            <label>상태 변경</label>
            <div>
              <label style="display:inline-flex; align-items:center; gap:8px;">
                <input type="checkbox" id="toggleStatus">
                <span>상태도 함께 변경</span>
              </label>
              <div class="mt-8">
                <!-- 체크가 되어야만 활성화; disabled면 전송되지 않아 서버에서 무시 가능 -->
                <select name="to" id="statusSelect" disabled>
			        <option value="" disabled selected hidden>변경할 상태 선택</option>
					  <option th:each="st : ${allStatuses}"
					          th:if="${st.name() != currentStatusName}"   
					          th:value="${st.name()}"
					          th:disabled="${!allowedStatusNames.contains(st.name())}"  
					          th:text="${statusLabel[st.name()]}"> 상태라벨
					          </option>
                </select>
              </div>
            </div>
          </div>
          <div class="actions save">
            <button type="submit" class="btn primary">저장</button>
          </div>
        </form>
      </section>
    </section>

    <!-- ===== 월 그리드(기록 있는 달만 활성) + 타임라인 ===== -->
    <section class="card" th:if="${isAdmin}">
      <h3>월별 상담 기록</h3>

      <!-- logFilterUrl을 JS에서 사용할 수 있도록 데이터 속성으로 보관 -->
      <div id="logFilterAnchor" th:data-url="${logFilterUrl}"></div>
      <div id="listRedirectAnchor" th:data-url="${listRedirect}"></div>

      <!-- 연도별 월 그리드 -->
      <div class="month-grid" th:each="y : ${yearOptions}">
        <div class="month-grid__year" th:text="|${y}년|">2025년</div>
        <div class="month-grid__cells">
          <button type="button"
                  class="month-btn"
                  th:each="m : ${#numbers.sequence(1,12)}"
                  th:data-year="${y}"
                  th:data-month="${m}"
                  th:title="|${y}년 ${m}월|" 
                  th:classappend="${countsByYear[y] != null and countsByYear[y].containsKey(m)} ? ' is-active' : ' is-disabled'"
                  th:text="|${m}월|">1월</button>
        </div>
      </div>
    </section>
    
    <section class="card" th:if="${isAdmin}">
      <h3>상담 내역</h3>
      <table class="table">
        <thead>
          <tr>
            <th>일시</th>
            <th>상태</th>
            <th>내용</th>
            <th>참고</th>
            <th>상담자</th>
            <th th:if="${isAdmin}">관리</th>
          </tr>
        </thead>
        <!-- 서버에서 초기 렌더 시 tbody 프래그먼트로 넣기 -->
        <tbody id="timelineBody" th:replace="~{fragments/applyEmpAdminLog :: timelineBody(${timeline}, ${isAdmin}, ${statusLabel})}">
        </tbody>
      </table>
    </section>
    
    <!-- 공통: 기본정보 (필수만) / 구인조건 -->
    <section class="card">
      <h3>기본정보</h3>
      <div class="grid two">
        <div class="row"><label>회사명</label><div th:text="${job.cmpName}">-</div></div>
        <div class="row"><label>담당자</label><div th:text="${job.contactName}">-</div></div>
        <div class="row"><label>연락처</label><div th:text="${job.contactPhone}">-</div></div>
        <div class="row"><label>작성일</label><div th:text="${#temporals.format(job.createdAt,'yyyy-MM-dd HH:mm')}">-</div></div>
      </div>

    <!-- ✅ 공통: 구인조건 표시 (프래그먼트) -->
    <div th:replace="~{fragments/applyEmpFragment :: jobConditionView(${job})}"></div>

      <!-- 관리자만 보는 내부 메모/소유자 등(있다면) -->
      <div class="grid two" th:if="${isAdmin}">
        <div class="row" th:if="${job.ownerAdminName}">
          <label>담당 관리자</label><div th:text="${job.ownerAdminName}"></div>
        </div>
        <div class="row" th:if="${job.adminNote}">
          <label>관리자 메모</label><div class="multiline" th:text="${job.adminNote}"></div>
        </div>
      </div>
    </section>
  </main>
	  <div class="actions list">
	    <a id="btnList" th:href="${listRedirect}" class="btn">목록</a>
	  </div>
    <footer class="foot-var">		
         <div>
  		<p> 
  		<span>(주)한국경영지원사업단&nbsp; 대표이사 : 이준희 <span class="divider">|</span> 사업자등록번호 : 887-81-00124</span><br>
        본사_경기도 김포시 김포한강4로 125 월드타워 705호 <span class="divider">|</span> 본부_경기도 광명시 일직로 43 GIDC A1706호<br>
        국내지사_김해지사, 대구지사, 천안지사, 광주지사, 원주지사 <span class="divider">|</span> 해외지사_베트남, 필리핀, 인도네시아, 인도, 몽골, 네팔, 우즈베키스탄<br>
        유료직업소개업 등록번호 : 제2025-4090515-14-5-00012호 <span class="divider">|</span> 
        Tel_ 031-983-0942 <span class="divider">|</span>  Fax_ 031-624-1540  <span class="divider">|</span> Email_ k-jobgo@naver.com<br>
 		ⓒ 2025 K-jobgo. All rights reserved.</p>
 		</div>
    </footer>
    
    <!-- JS 연결 -->
    <script th:src="@{/js/common.js}"></script>
    <script th:src="@{/js/login.js}"></script>
    <!-- 권장: Thymeleaf 유틸로 현재시간 -->
	<script th:src="@{/js/applyEmp.js}"></script>
</body>
</html>